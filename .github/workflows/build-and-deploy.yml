name: Build and Deploy Electron App

on:
  push:
    branches: [main]
  release:
    types: [published]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            platform: linux
            artifact-name: fos-printer-linux
          - os: macos-latest
            platform: mac
            artifact-name: fos-printer-mac
          - os: windows-latest
            platform: win
            artifact-name: fos-printer-win

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "yarn"

      - name: Install yarn
        run: npm install -g yarn

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build Electron app
        shell: bash
        run: |
          if [ "${{ matrix.platform }}" = "mac" ]; then
            yarn electron:build:mac
          elif [ "${{ matrix.platform }}" = "win" ]; then
            yarn electron:build:win
          elif [ "${{ matrix.platform }}" = "linux" ]; then
            yarn electron:build:linux
          fi

      - name: Create zip files
        shell: bash
        run: |
          cd release

          # List all files in release directory for debugging
          echo "Files in release directory:"
          ls -la

          # Create platform-specific zip files with flexible file matching
          if [ "${{ matrix.platform }}" = "mac" ]; then
            # Find macOS DMG file
            DMG_FILE=$(find . -name "*.dmg" -type f | head -1)
            if [ -n "$DMG_FILE" ]; then
              # Create README.md in release directory (English)
              echo "# Food Order Printer - macOS Installation" > README.md
              echo "" >> README.md
              echo "## If you see \"damaged\" error when trying to open the app:" >> README.md
              echo "" >> README.md
              echo "### Method 1: Using Terminal (Recommended)" >> README.md
              echo "" >> README.md
              echo "1. **Open Terminal:**" >> README.md
              echo "   - Press `Cmd + Space` to open Spotlight Search" >> README.md
              echo "   - Type \"Terminal\" and press Enter" >> README.md
              echo "   - Or go to Applications > Utilities > Terminal" >> README.md
              echo "" >> README.md
              echo "2. **Navigate to your Downloads folder:**" >> README.md
              echo "   - In the Terminal window, type: \`cd Downloads\`" >> README.md
              echo "   - Press Enter" >> README.md
              echo "" >> README.md
              echo "3. **Run the security command:**" >> README.md
              echo "   - Copy and paste this command: \`xattr -cr \"Food Order Printer.app\"\`" >> README.md
              echo "   - Press Enter" >> README.md
              echo "   - You should see no output (this is normal)" >> README.md
              echo "" >> README.md
              echo "4. **Open the app:**" >> README.md
              echo "   - Now you can double-click \"Food Order Printer.app\" to open it normally" >> README.md
              echo "" >> README.md
              echo "### Method 2: Right-click Method (Easier)" >> README.md
              echo "" >> README.md
              echo "1. **Right-click** on \"Food Order Printer.app\"" >> README.md
              echo "2. Select **\"Open\"** from the context menu" >> README.md
              echo "3. Click **\"Open\"** in the security dialog that appears" >> README.md
              echo "4. The app will now open and remember this choice for future launches" >> README.md
              echo "" >> README.md
              echo "## Why this happens:" >> README.md
              echo "macOS Gatekeeper blocks unsigned apps for security. This is normal for open-source projects that aren't code-signed with an Apple Developer certificate." >> README.md
              echo "" >> README.md
              echo "## Need help?" >> README.md
              echo "If you're still having trouble, try Method 2 first as it's simpler. Method 1 is more permanent but requires using Terminal." >> README.md
              
              # Create README_TH.md in release directory (Thai)
              echo "# Food Order Printer - à¸à¸²à¸£à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡à¸šà¸™ macOS" > README_TH.md
              echo "" >> README_TH.md
              echo "## à¸«à¸²à¸à¸„à¸¸à¸“à¹€à¸«à¹‡à¸™à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸” \"à¹€à¸ªà¸µà¸¢à¸«à¸²à¸¢\" à¹€à¸¡à¸·à¹ˆà¸­à¸žà¸¢à¸²à¸¢à¸²à¸¡à¹€à¸›à¸´à¸”à¹à¸­à¸›:" >> README_TH.md
              echo "" >> README_TH.md
              echo "### à¸§à¸´à¸˜à¸µà¸—à¸µà¹ˆ 1: à¹ƒà¸Šà¹‰ Terminal (à¹à¸™à¸°à¸™à¸³)" >> README_TH.md
              echo "" >> README_TH.md
              echo "1. **à¹€à¸›à¸´à¸” Terminal:**" >> README_TH.md
              echo "   - à¸à¸” `Cmd + Space` à¹€à¸žà¸·à¹ˆà¸­à¹€à¸›à¸´à¸” Spotlight Search" >> README_TH.md
              echo "   - à¸žà¸´à¸¡à¸žà¹Œ \"Terminal\" à¹à¸¥à¸°à¸à¸” Enter" >> README_TH.md
              echo "   - à¸«à¸£à¸·à¸­à¹„à¸›à¸—à¸µà¹ˆ Applications > Utilities > Terminal" >> README_TH.md
              echo "" >> README_TH.md
              echo "2. **à¹„à¸›à¸—à¸µà¹ˆà¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œ Downloads:**" >> README_TH.md
              echo "   - à¹ƒà¸™à¸«à¸™à¹‰à¸²à¸•à¹ˆà¸²à¸‡ Terminal à¸žà¸´à¸¡à¸žà¹Œ: \`cd Downloads\`" >> README_TH.md
              echo "   - à¸à¸” Enter" >> README_TH.md
              echo "" >> README_TH.md
              echo "3. **à¸£à¸±à¸™à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸„à¸§à¸²à¸¡à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢:**" >> README_TH.md
              echo "   - à¸„à¸±à¸”à¸¥à¸­à¸à¹à¸¥à¸°à¸§à¸²à¸‡à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸™à¸µà¹‰: \`xattr -cr \"Food Order Printer.app\"\`" >> README_TH.md
              echo "   - à¸à¸” Enter" >> README_TH.md
              echo "   - à¸„à¸¸à¸“à¸ˆà¸°à¹„à¸¡à¹ˆà¹€à¸«à¹‡à¸™à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œà¹ƒà¸”à¹† (à¸™à¸µà¹ˆà¹€à¸›à¹‡à¸™à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸›à¸à¸•à¸´)" >> README_TH.md
              echo "" >> README_TH.md
              echo "4. **à¹€à¸›à¸´à¸”à¹à¸­à¸›:**" >> README_TH.md
              echo "   - à¸•à¸­à¸™à¸™à¸µà¹‰à¸„à¸¸à¸“à¸ªà¸²à¸¡à¸²à¸£à¸–à¸”à¸±à¸šà¹€à¸šà¸´à¸¥à¸„à¸¥à¸´à¸ \"Food Order Printer.app\" à¹€à¸žà¸·à¹ˆà¸­à¹€à¸›à¸´à¸”à¹„à¸”à¹‰à¸•à¸²à¸¡à¸›à¸à¸•à¸´" >> README_TH.md
              echo "" >> README_TH.md
              echo "### à¸§à¸´à¸˜à¸µà¸—à¸µà¹ˆ 2: à¸§à¸´à¸˜à¸µà¸„à¸¥à¸´à¸à¸‚à¸§à¸² (à¸‡à¹ˆà¸²à¸¢à¸à¸§à¹ˆà¸²)" >> README_TH.md
              echo "" >> README_TH.md
              echo "1. **à¸„à¸¥à¸´à¸à¸‚à¸§à¸²** à¸šà¸™ \"Food Order Printer.app\"" >> README_TH.md
              echo "2. à¹€à¸¥à¸·à¸­à¸ **\"à¹€à¸›à¸´à¸”\"** à¸ˆà¸²à¸à¹€à¸¡à¸™à¸¹" >> README_TH.md
              echo "3. à¸„à¸¥à¸´à¸ **\"à¹€à¸›à¸´à¸”\"** à¹ƒà¸™à¸à¸¥à¹ˆà¸­à¸‡à¹‚à¸•à¹‰à¸•à¸­à¸šà¸„à¸§à¸²à¸¡à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢à¸—à¸µà¹ˆà¸›à¸£à¸²à¸à¸" >> README_TH.md
              echo "4. à¹à¸­à¸›à¸ˆà¸°à¹€à¸›à¸´à¸”à¹à¸¥à¸°à¸ˆà¸³à¸à¸²à¸£à¹€à¸¥à¸·à¸­à¸à¸™à¸µà¹‰à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¹€à¸›à¸´à¸”à¸„à¸£à¸±à¹‰à¸‡à¸•à¹ˆà¸­à¹„à¸›" >> README_TH.md
              echo "" >> README_TH.md
              echo "## à¸—à¸³à¹„à¸¡à¸–à¸¶à¸‡à¹€à¸›à¹‡à¸™à¹à¸šà¸šà¸™à¸µà¹‰:" >> README_TH.md
              echo "macOS Gatekeeper à¸ˆà¸°à¸šà¸¥à¹‡à¸­à¸à¹à¸­à¸›à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸¥à¸‡à¸™à¸²à¸¡à¹€à¸žà¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢ à¸™à¸µà¹ˆà¹€à¸›à¹‡à¸™à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸›à¸à¸•à¸´à¸ªà¸³à¸«à¸£à¸±à¸šà¹‚à¸›à¸£à¹€à¸ˆà¸à¸•à¹Œà¹‚à¸­à¹€à¸žà¸™à¸‹à¸­à¸£à¹Œà¸ªà¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸¥à¸‡à¸™à¸²à¸¡à¸”à¹‰à¸§à¸¢à¹ƒà¸šà¸£à¸±à¸šà¸£à¸­à¸‡ Apple Developer" >> README_TH.md
              echo "" >> README_TH.md
              echo "## à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸„à¸§à¸²à¸¡à¸Šà¹ˆà¸§à¸¢à¹€à¸«à¸¥à¸·à¸­?" >> README_TH.md
              echo "à¸«à¸²à¸à¸„à¸¸à¸“à¸¢à¸±à¸‡à¸¡à¸µà¸›à¸±à¸à¸«à¸² à¸¥à¸­à¸‡à¹ƒà¸Šà¹‰à¸§à¸´à¸˜à¸µà¸—à¸µà¹ˆ 2 à¸à¹ˆà¸­à¸™à¹€à¸žà¸£à¸²à¸°à¸‡à¹ˆà¸²à¸¢à¸à¸§à¹ˆà¸² à¸§à¸´à¸˜à¸µà¸—à¸µà¹ˆ 1 à¸ˆà¸°à¹à¸à¹‰à¸›à¸±à¸à¸«à¸²à¹à¸šà¸šà¸–à¸²à¸§à¸£à¹à¸•à¹ˆà¸•à¹‰à¸­à¸‡à¹ƒà¸Šà¹‰ Terminal" >> README_TH.md
              
              # Create zip with DMG and both README files
              zip -r "../${{ matrix.artifact-name }}.zip" "$DMG_FILE" README.md README_TH.md
              echo "âœ… Created ${{ matrix.artifact-name }}.zip with $DMG_FILE, README.md, and README_TH.md"
            else
              echo "âŒ No DMG file found for macOS - build may have failed"
              exit 1
            fi
          elif [ "${{ matrix.platform }}" = "win" ]; then
            # Find Windows EXE file
            EXE_FILE=$(find . -name "*.exe" -type f | head -1)
            if [ -n "$EXE_FILE" ]; then
              # Use PowerShell to create zip on Windows
              powershell -Command "Compress-Archive -Path '$EXE_FILE' -DestinationPath '../${{ matrix.artifact-name }}.zip' -Force"
              echo "âœ… Created ${{ matrix.artifact-name }}.zip with $EXE_FILE"
            else
              echo "âŒ No EXE file found for Windows - build may have failed"
              exit 1
            fi
          elif [ "${{ matrix.platform }}" = "linux" ]; then
            # Find Linux AppImage file
            APPIMAGE_FILE=$(find . -name "*.AppImage" -type f | head -1)
            if [ -n "$APPIMAGE_FILE" ]; then
              zip -r ../${{ matrix.artifact-name }}.zip "$APPIMAGE_FILE"
              echo "âœ… Created ${{ matrix.artifact-name }}.zip with $APPIMAGE_FILE"
            else
              echo "âŒ No AppImage file found for Linux - build may have failed"
              exit 1
            fi
          fi

          # Verify zip file was created
          if [ ! -f "../${{ matrix.artifact-name }}.zip" ]; then
            echo "âŒ Zip file was not created successfully"
            exit 1
          fi

          echo "âœ… Zip file verification complete: ${{ matrix.artifact-name }}.zip"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}-${{ matrix.os }}
          path: ${{ matrix.artifact-name }}.zip
          retention-days: 30

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'release'
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Create final zip files
        run: |
          echo "ðŸ“¦ Creating final zip files for GitHub Pages..."

          # Create docs directory if it doesn't exist
          mkdir -p docs

          # Copy the index.html to docs (if it exists)
          if [ -f "docs/index.html" ]; then
            echo "âœ… index.html found and copied"
          else
            echo "âŒ Error: docs/index.html not found"
            exit 1
          fi

          # Find and copy zip files from artifacts
          echo "ðŸ“ Copying zip files from artifacts..."
          ZIP_COUNT=0
          find artifacts -name "*.zip" -type f | while read file; do
            filename=$(basename "$file")
            echo "  ðŸ“‹ Copying $filename to docs/"
            cp "$file" "docs/$filename"
            ZIP_COUNT=$((ZIP_COUNT + 1))
          done

          # Check if we have the expected zip files
          echo "ðŸ“Š Checking zip files..."
          if [ -f "docs/fos-printer-mac.zip" ] && [ -f "docs/fos-printer-win.zip" ] && [ -f "docs/fos-printer-linux.zip" ]; then
            echo "âœ… All platform-specific zip files found"
            
            # Create all-platforms zip
            echo "ðŸ“¦ Creating fos-printer-app.zip with all platforms..."
            cd docs
            zip fos-printer-app.zip fos-printer-mac.zip fos-printer-win.zip fos-printer-linux.zip
            cd ..
            echo "âœ… fos-printer-app.zip created"
          else
            echo "âš ï¸  Missing some platform zip files:"
            ls -la docs/*.zip 2>/dev/null || echo "No zip files found"
          fi

          # Get version from package.json
          VERSION=$(node -p "require('./package.json').version")
          echo "ðŸ“ Creating version.json with version: $VERSION"
          cat > docs/version.json << EOF
          {
            "version": "$VERSION",
            "buildDate": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "commit": "${{ github.sha }}",
            "buildNumber": "${{ github.run_number }}"
          }
          EOF

          # List files in docs directory
          echo "ðŸ“‹ Files in docs directory:"
          ls -la docs/

          # Verify required files exist
          echo "ðŸ” Verifying required files for deployment..."
          REQUIRED_FILES=("index.html" "version.json" "fos-printer-mac.zip" "fos-printer-win.zip" "fos-printer-linux.zip" "fos-printer-app.zip")
          MISSING_FILES=()

          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "docs/$file" ]; then
              MISSING_FILES+=("$file")
            else
              echo "âœ… $file found"
            fi
          done

          if [ ${#MISSING_FILES[@]} -gt 0 ]; then
            echo "âŒ Missing required files: ${MISSING_FILES[*]}"
            exit 1
          fi

          echo "ðŸŽ‰ All required files verified successfully!"

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./docs

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
